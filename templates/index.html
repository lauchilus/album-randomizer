<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Album Randomizer</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background-color: #1e1e2f;
            color: #e0e0f0;
        }
        table { 
            border-collapse: collapse; 
            width: 100%; 
            margin-top: 10px; 
            background-color: #2a2a40;
        }
        th, td { 
            border: 1px solid #444; 
            padding: 5px; 
            text-align: left; 
            vertical-align: middle;
        }
        th { 
            background-color: #3b3b5a; 
        }
        input { 
            padding: 5px; 
            margin-bottom: 10px; 
            width: 300px; 
            background-color: #2a2a40;
            border: 1px solid #555;
            color: #e0e0f0;
        }
        button { 
            margin-right: 5px; 
            padding: 5px 10px; 
            background-color: #4a4abf;
            color: #fff;
            border: none;
            cursor: pointer;
            border-radius: 4px;
        }
        button:disabled { 
            background-color: #888; 
            cursor: default;
        }
        #albumDisplay { 
            margin-bottom: 20px; 
        }
        #albumDisplay img {
            max-width: 250px;
            margin-top: 10px;
            border-radius: 6px;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        table img {
            max-width: 50px;
            border-radius: 4px;
        }
        .pagination { 
            margin-top: 10px; 
        }
        .pagination button { 
            padding: 5px 8px; 
            margin-right: 3px; 
            background-color: #6a6ae0;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <h1>Mis Álbumes</h1>

    <button id="randomBtn">Sorpresa Aleatoria!</button>
    <button id="resetBtn">Reiniciar escuchados</button>

    <br><br>

    <div id="albumDisplay"></div>

    <h2>Listado completo</h2>
    <input type="text" id="searchInput" placeholder="Buscar por título, artista, país o año">

    <table id="albumTable">
        <thead>
            <tr>
                <th>Rank</th>
                <th>Portada</th>
                <th>Title</th>
                <th>Band</th>
                <th>Country</th>
                <th>Year</th>
                <th>Escuchado</th>
                <th>Acción</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <div class="pagination" id="pagination"></div>

<script>
(() => {
    let albums = JSON.parse('{{.albumsJS}}');
    let currentAlbum = null;
    const perPage = 500;
    let currentPage = 1;
    let filteredAlbums = albums.slice();

    function renderTable(page = 1) {
        const tbody = document.querySelector("#albumTable tbody");
        tbody.innerHTML = "";

        const start = (page - 1) * perPage;
        const end = start + perPage;
        const pageAlbums = filteredAlbums.slice(start, end);

        pageAlbums.forEach(a => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${a.Rank}</td>
                <td>${a.CoverURL ? `<img src="${a.CoverURL}" alt="Portada">` : ""}</td>
                <td>${a.Title}</td>
                <td>${a.Band}</td>
                <td>${a.Country}</td>
                <td>${a.Year}</td>
                <td>${a.TimesListened}</td>
                <td><button class="markBtn" data-id="${a.ID}">Marcar escuchado</button></td>
            `;
            tbody.appendChild(tr);
        });

        tbody.querySelectorAll(".markBtn").forEach(btn => {
            btn.addEventListener("click", async () => {
                const id = btn.getAttribute("data-id");
                const res = await fetch(`/mark-listened/${id}`, { method: "POST" });
                const updated = await res.json();
                albums = albums.map(a => a.ID == updated.ID ? updated : a);
                const q = document.getElementById("searchInput").value.toLowerCase().trim();
                filteredAlbums = albums.filter(a =>
                    a.Title.toLowerCase().includes(q) ||
                    a.Band.toLowerCase().includes(q) ||
                    a.Country.toLowerCase().includes(q) ||
                    a.Year.toString().includes(q)
                );
                renderTable(currentPage);
            });
        });

        renderPagination();
    }

    function renderPagination() {
        const paginationDiv = document.getElementById("pagination");
        paginationDiv.innerHTML = "";
        const totalPages = Math.ceil(filteredAlbums.length / perPage);

        for(let i=1;i<=totalPages;i++){
            const btn = document.createElement("button");
            btn.textContent = i;
            if(i===currentPage) btn.disabled = true;
            btn.addEventListener("click",()=>{currentPage=i; renderTable(i);});
            paginationDiv.appendChild(btn);
        }
    }

    // Random album
    document.getElementById("randomBtn").addEventListener("click", async () => {
        const res = await fetch("/random", {method: "POST"});
        const album = await res.json();

        if(album.message){
            document.getElementById("albumDisplay").innerHTML = `<p>${album.message}</p>`;
            currentAlbum = null;
            return;
        }

        currentAlbum = album;

        document.getElementById("albumDisplay").innerHTML = `
            <h2>${album.Title} (${album.Year})</h2>
            <p>Artista: ${album.Band}</p>
            <p>País: ${album.Country}</p>
            <p>Escuchado: ${album.TimesListened}</p>
            ${album.CoverURL ? `<img src="${album.CoverURL}" alt="Portada">` : ""}
            <br><button id="markRandomBtn">Marcar como escuchado</button>
        `;

        document.getElementById("markRandomBtn").addEventListener("click", async () => {
            if(!currentAlbum) return;
            const res = await fetch(`/mark-listened/${currentAlbum.ID}`, {method: "POST"});
            const updated = await res.json();
            currentAlbum = updated;

            document.getElementById("albumDisplay").innerHTML = `
                <h2>${updated.Title} (${updated.Year})</h2>
                <p>Artista: ${updated.Band}</p>
                <p>País: ${updated.Country}</p>
                <p>Escuchado: ${updated.TimesListened} ✅</p>
                ${updated.CoverURL ? `<img src="${updated.CoverURL}" alt="Portada">` : ""}
            `;

            albums = albums.map(a => a.ID === updated.ID ? updated : a);
            const q = document.getElementById("searchInput").value.toLowerCase().trim();
            filteredAlbums = albums.filter(a =>
                a.Title.toLowerCase().includes(q) ||
                a.Band.toLowerCase().includes(q) ||
                a.Country.toLowerCase().includes(q) ||
                a.Year.toString().includes(q)
            );
            renderTable(currentPage);
        });
    });

    // Reset escuchados
    document.getElementById("resetBtn").addEventListener("click", async () => {
        const res = await fetch("/reset", {method: "POST"});
        const data = await res.json();
        document.getElementById("albumDisplay").innerHTML = `<p>${data.message}</p>`;
        albums.forEach(a => a.TimesListened = 0);

        const q = document.getElementById("searchInput").value.toLowerCase().trim();
        filteredAlbums = albums.filter(a =>
            a.Title.toLowerCase().includes(q) ||
            a.Band.toLowerCase().includes(q) ||
            a.Country.toLowerCase().includes(q) ||
            a.Year.toString().includes(q)
        );

        renderTable(currentPage);
    });

    // Búsqueda dinámica
    document.getElementById("searchInput").addEventListener("input", () => {
        const q = document.getElementById("searchInput").value.toLowerCase().trim();
        filteredAlbums = albums.filter(a =>
            a.Title.toLowerCase().includes(q) ||
            a.Band.toLowerCase().includes(q) ||
            a.Country.toLowerCase().includes(q) ||
            a.Year.toString().includes(q)
        );
        currentPage = 1;
        renderTable(currentPage);
    });

    renderTable(currentPage);
})();
</script>
</body>
</html>
