<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Album Randomizer</title>
<style>
/* --- Variables de color --- */
:root {
    --bg-light: #f5f5f5;
    --bg-dark: #1c1c2e;
    --text-light: #fff;
    --text-dark: #333;
    --primary: #5c6bc0; /* violeta-azulado */
    --secondary: #7986cb;
    --accent: #448aff; /* azul brillante */
    --hover: #3949ab;
    --reset-color: #ff7043;
    --mark-color: #7c4dff;
}

/* --- Reset b√°sico --- */
* { box-sizing: border-box; margin: 0; padding: 0; }

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    padding: 30px;
    background-color: var(--bg-light);
    color: var(--text-dark);
    transition: all 0.3s ease;
}

/* --- Modo oscuro --- */
body.dark {
    background-color: var(--bg-dark);
    color: var(--text-light);
}

h1 {
    color: var(--primary);
    margin-bottom: 20px;
}

/* --- Botones --- */
button {
    padding: 8px 14px;
    margin-right: 5px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.2s ease;
}

button:hover { opacity: 0.9; }

#randomBtn { background-color: var(--accent); color: #fff; }
#resetBtn { background-color: var(--reset-color); color: #fff; }
#toggleDark { background-color: var(--secondary); color: #fff; }
#markRandomBtn { background-color: var(--mark-color); color: #fff; margin-top: 10px; }
.markBtn { background-color: var(--secondary); color: #fff; border-radius: 4px; }

/* --- Input b√∫squeda --- */
#searchInput {
    padding: 8px;
    width: 300px;
    border-radius: 6px;
    border: 1px solid #ccc;
    margin-bottom: 15px;
    transition: all 0.3s ease;
}

body.dark #searchInput {
    background-color: #2c2c3d;
    border-color: #555;
    color: #eee;
}

/* --- Tabla --- */
table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 0 10px rgba(0,0,0,0.05);
    background-color: #fff;
    transition: all 0.3s ease;
}

body.dark table { background-color: #2c2c3d; }

th, td {
    padding: 10px 12px;
    text-align: left;
}

th {
    background-color: var(--primary);
    color: #fff;
    font-weight: 600;
}

tbody tr:nth-child(even) { background-color: #f9f9f9; }
tbody tr:hover { background-color: #e3f2fd; }

body.dark tbody tr:nth-child(even) { background-color: #28283a; }
body.dark tbody tr:hover { background-color: #3a3a5c; }

/* --- Display de √°lbum random --- */
#albumDisplay {
    margin-bottom: 30px;
    padding: 15px 20px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    background-color: #fff;
    transition: all 0.3s ease;
}

body.dark #albumDisplay { background-color: #2c2c3d; }

#albumDisplay h2 { color: var(--primary); margin-bottom: 5px; }
#albumDisplay p { margin: 4px 0; }

/* --- Paginaci√≥n --- */
.pagination {
    margin-top: 15px;
}

.pagination button {
    padding: 6px 10px;
    margin-right: 5px;
    border-radius: 6px;
    border: 1px solid #ccc;
    background-color: #fff;
    cursor: pointer;
    transition: all 0.2s ease;
}

.pagination button:hover { background-color: #f0f0f0; }
.pagination button:disabled {
    background-color: var(--accent);
    color: #fff;
    cursor: default;
    border: none;
}

body.dark .pagination button { background-color: #3a3a5c; border-color: #555; }
body.dark .pagination button:hover { background-color: #50507a; }
body.dark .pagination button:disabled { background-color: var(--accent); color: #fff; }

</style>
</head>
<body>
<h1>Mis √Ålbumes</h1>

<button id="randomBtn">üé≤ Sorpresa Aleatoria!</button>
<button id="resetBtn">üîÑ Reiniciar escuchados</button>
<button id="toggleDark">üåô Modo Oscuro</button>

<div id="albumDisplay"></div>

<h2>Listado completo</h2>
<input type="text" id="searchInput" placeholder="Buscar por t√≠tulo, artista, pa√≠s o a√±o">

<table id="albumTable">
    <thead>
        <tr>
            <th>Rank</th>
            <th>Title</th>
            <th>Band</th>
            <th>Country</th>
            <th>Year</th>
            <th>Escuchado</th>
            <th>Acci√≥n</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<div class="pagination" id="pagination"></div>

<script>
(() => {
    let albums = JSON.parse('{{.albumsJS}}');
    let currentAlbum = null;
    const perPage = 500;
    let currentPage = 1;
    let filteredAlbums = albums.slice();

    const body = document.body;
    document.getElementById("toggleDark").addEventListener("click", () => {
        body.classList.toggle("dark");
    });

    function renderTable(page = 1) {
        const tbody = document.querySelector("#albumTable tbody");
        tbody.innerHTML = "";

        const start = (page - 1) * perPage;
        const end = start + perPage;
        const pageAlbums = filteredAlbums.slice(start, end);

        pageAlbums.forEach(a => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${a.Rank}</td>
                <td>${a.Title}</td>
                <td>${a.Band}</td>
                <td>${a.Country}</td>
                <td>${a.Year}</td>
                <td>${a.TimesListened}</td>
                <td><button class="markBtn" data-id="${a.ID}">Marcar escuchado</button></td>
            `;
            tbody.appendChild(tr);
        });

        tbody.querySelectorAll(".markBtn").forEach(btn => {
            btn.addEventListener("click", async () => {
                const id = btn.getAttribute("data-id");
                const res = await fetch(`/mark-listened/${id}`, { method: "POST" });
                const updated = await res.json();
                albums = albums.map(a => a.ID == updated.ID ? updated : a);

                const q = document.getElementById("searchInput").value.toLowerCase().trim();
                filteredAlbums = albums.filter(a =>
                    a.Title.toLowerCase().includes(q) ||
                    a.Band.toLowerCase().includes(q) ||
                    a.Country.toLowerCase().includes(q) ||
                    a.Year.toString().includes(q)
                );

                renderTable(currentPage);
            });
        });

        renderPagination();
    }

    function renderPagination() {
        const paginationDiv = document.getElementById("pagination");
        paginationDiv.innerHTML = "";
        const totalPages = Math.ceil(filteredAlbums.length / perPage);

        for(let i=1;i<=totalPages;i++){
            const btn = document.createElement("button");
            btn.textContent = i;
            if(i===currentPage) btn.disabled = true;
            btn.addEventListener("click",()=>{currentPage=i; renderTable(i);});
            paginationDiv.appendChild(btn);
        }
    }

    document.getElementById("randomBtn").addEventListener("click", async () => {
        const res = await fetch("/random", {method: "POST"});
        const album = await res.json();
        if(album.message){
            document.getElementById("albumDisplay").innerHTML = `<p>${album.message}</p>`;
            currentAlbum = null;
            return;
        }
        currentAlbum = album;
        document.getElementById("albumDisplay").innerHTML = `
            <h2>${album.Title} (${album.Year})</h2>
            <p>Artista: ${album.Band}</p>
            <p>Pa√≠s: ${album.Country}</p>
            <p>Escuchado: ${album.TimesListened}</p>
            <button id="markRandomBtn">Marcar como escuchado</button>
        `;

        document.getElementById("markRandomBtn").addEventListener("click", async () => {
            if(!currentAlbum) return;
            const res = await fetch(`/mark-listened/${currentAlbum.ID}`, {method: "POST"});
            const updated = await res.json();
            currentAlbum = updated;

            document.getElementById("albumDisplay").innerHTML = `
                <h2>${updated.Title} (${updated.Year})</h2>
                <p>Artista: ${updated.Band}</p>
                <p>Pa√≠s: ${updated.Country}</p>
                <p>Escuchado: ${updated.TimesListened} ‚úÖ</p>
            `;

            albums = albums.map(a => a.ID === updated.ID ? updated : a);
            const q = document.getElementById("searchInput").value.toLowerCase().trim();
            filteredAlbums = albums.filter(a =>
                a.Title.toLowerCase().includes(q) ||
                a.Band.toLowerCase().includes(q) ||
                a.Country.toLowerCase().includes(q) ||
                a.Year.toString().includes(q)
            );
            renderTable(currentPage);
        });
    });

    document.getElementById("resetBtn").addEventListener("click", async () => {
        const res = await fetch("/reset", {method: "POST"});
        const data = await res.json();
        document.getElementById("albumDisplay").innerHTML = `<p>${data.message}</p>`;
        albums.forEach(a => a.TimesListened = 0);

        const q = document.getElementById("searchInput").value.toLowerCase().trim();
        filteredAlbums = albums.filter(a =>
            a.Title.toLowerCase().includes(q) ||
            a.Band.toLowerCase().includes(q) ||
            a.Country.toLowerCase().includes(q) ||
            a.Year.toString().includes(q)
        );

        renderTable(currentPage);
    });

    document.getElementById("searchInput").addEventListener("input", () => {
        const q = document.getElementById("searchInput").value.toLowerCase().trim();
        filteredAlbums = albums.filter(a =>
            a.Title.toLowerCase().includes(q) ||
            a.Band.toLowerCase().includes(q) ||
            a.Country.toLowerCase().includes(q) ||
            a.Year.toString().includes(q)
        );
        currentPage = 1;
        renderTable(currentPage);
    });

    renderTable(currentPage);
})();
</script>
</body>
</html>
